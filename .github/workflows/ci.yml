name: CI

on:
    push:
        branches: [ main ]
    pull_request:
        branches: [ main ]

jobs:
    lint-and-test:
        name: Lint and Test
        runs-on: ubuntu-latest
        steps:
            - name: Check out code
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: '1.23'

            - name: Format check
              run: |
                  if [ -n "$(gofmt -l .)" ]; then
                      echo "Go code is not formatted. Run 'gofmt -w .' to fix:"
                      gofmt -d .
                      exit 1
                  fi

            - name: Install golangci-lint
              run: |
                  curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.61.0
                  echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

            - name: Lint Go code
              run: golangci-lint run --timeout=5m

            - name: Run tests
              run: go test -v ./...

            - name: Build radar
              run: CGO_ENABLED=0 go build -ldflags="-s -w" -o radar .

            - name: Upload Linux binary
              uses: actions/upload-artifact@v4
              with:
                  name: radar-linux
                  path: radar
                  retention-days: 1

    integration-test:
        name: Integration Test - Root=${{ matrix.root }} Super=${{ matrix.pg_superuser }}
        runs-on: ubuntu-latest
        needs: lint-and-test
        strategy:
            matrix:
                include:
                    - root: "false"
                      pg_superuser: "false"
                    - root: "false"
                      pg_superuser: "true"
                    - root: "true"
                      pg_superuser: "false"
                    - root: "true"
                      pg_superuser: "true"
        steps:
            - name: Download Linux binary
              uses: actions/download-artifact@v4
              with:
                  name: radar-linux

            - name: Make binary executable
              run: chmod +x radar

            - name: Create Dockerfile for integration test
              run: |
                  cat > Dockerfile.test <<'EOF'
                  FROM debian:bookworm-slim

                  # Install PostgreSQL 18 and pg_statviz extension
                  RUN apt-get update && \
                      apt-get install -y wget gnupg2 lsb-release sudo && \
                      wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | gpg --dearmor -o /etc/apt/trusted.gpg.d/postgresql.gpg && \
                      echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list && \
                      apt-get update && \
                      apt-get install -y \
                          postgresql-18 \
                          postgresql-18-statviz && \
                      apt-get clean && \
                      rm -rf /var/lib/apt/lists/*

                  # Copy radar binary
                  COPY radar /usr/local/bin/radar
                  RUN chmod +x /usr/local/bin/radar

                  # Copy test script
                  COPY test-integration.sh /test-integration.sh
                  RUN chmod +x /test-integration.sh

                  CMD ["/test-integration.sh"]
                  EOF

            - name: Create integration test script
              run: |
                  cat > test-integration.sh <<'EOF'
                  #!/bin/bash
                  set -e

                  echo "=== Test Configuration ==="
                  echo "Root: ${ROOT:-true}"
                  echo "PostgreSQL superuser: ${PG_SUPERUSER:-true}"

                  # Create non-root system user if needed
                  if [ "${ROOT}" = "false" ]; then
                      echo "=== Creating non-root system user ==="
                      useradd -m -s /bin/bash testuser
                      echo "testuser ALL=(postgres) NOPASSWD: ALL" >> /etc/sudoers
                  fi

                  echo "=== Initializing PostgreSQL 18 ==="
                  rm -rf /var/lib/postgresql/18/main
                  mkdir -p /var/lib/postgresql/18/main
                  chown -R postgres:postgres /var/lib/postgresql
                  sudo -u postgres /usr/lib/postgresql/18/bin/initdb -D /var/lib/postgresql/18/main

                  echo "=== Starting PostgreSQL 18 ==="
                  sudo -u postgres /usr/lib/postgresql/18/bin/pg_ctl -D /var/lib/postgresql/18/main -l /tmp/postgres.log start

                  # Wait for PostgreSQL to be ready
                  echo "=== Waiting for PostgreSQL to be ready ==="
                  for i in {1..30}; do
                      if sudo -u postgres /usr/lib/postgresql/18/bin/pg_isready -q; then
                          echo "PostgreSQL is ready"
                          break
                      fi
                      echo "Waiting for PostgreSQL... ($i/30)"
                      sleep 1
                  done

                  if ! sudo -u postgres /usr/lib/postgresql/18/bin/pg_isready -q; then
                      echo "ERROR: PostgreSQL failed to start"
                      cat /tmp/postgres.log
                      exit 1
                  fi

                  echo "=== Creating test database ==="
                  sudo -u postgres psql -c "CREATE DATABASE testdb;"

                  echo "=== Installing pg_statviz extension ==="
                  sudo -u postgres psql -d testdb -c "CREATE EXTENSION pg_statviz;"

                  echo "=== Taking pg_statviz snapshot ==="
                  sudo -u postgres psql -d testdb -c "SELECT pgstatviz.snapshot();"

                  echo "=== Creating PostgreSQL test user ==="
                  export PGPASSWORD=testpass
                  if [ "${PG_SUPERUSER}" = "true" ]; then
                      sudo -u postgres psql -c "CREATE USER testpguser WITH SUPERUSER PASSWORD 'testpass';"
                  else
                      sudo -u postgres psql -c "CREATE USER testpguser PASSWORD 'testpass';"
                      sudo -u postgres psql -d testdb -c "GRANT CONNECT ON DATABASE testdb TO testpguser;"
                      sudo -u postgres psql -d testdb -c "GRANT USAGE ON SCHEMA pgstatviz TO testpguser;"
                      sudo -u postgres psql -d testdb -c "GRANT SELECT ON ALL TABLES IN SCHEMA pgstatviz TO testpguser;"
                  fi

                  echo "=== Running radar collection ==="
                  if [ "${ROOT}" = "true" ]; then
                      PGPASSWORD=testpass radar -h localhost -d testdb -U testpguser -v
                  else
                      sudo -u testuser bash -c "cd /home/testuser && PGPASSWORD=testpass radar -h localhost -d testdb -U testpguser -v"
                  fi

                  echo "=== Verifying output ==="
                  if [ "${ROOT}" = "true" ]; then
                      ZIPFILE=$(ls radar-*.zip 2>/dev/null | head -1)
                  else
                      ZIPFILE=$(ls /home/testuser/radar-*.zip 2>/dev/null | head -1)
                  fi

                  if [ -z "$ZIPFILE" ]; then
                      echo "ERROR: No radar output file found"
                      ls -la
                      if [ "${ROOT}" = "false" ]; then
                          ls -la /home/testuser/
                      fi
                      exit 1
                  fi

                  echo "Found output file: $ZIPFILE"

                  # Install unzip for verification
                  apt-get update && apt-get install -y unzip

                  echo "=== ZIP file contents ==="
                  unzip -l "$ZIPFILE" | head -30

                  echo "=== Checking for system collectors ==="
                  if ! unzip -l "$ZIPFILE" | grep -q "system/hostname.out"; then
                      echo "ERROR: Missing system data"
                      exit 1
                  fi
                  echo "✓ System data found"

                  echo "=== Checking for PostgreSQL collectors ==="
                  if ! unzip -l "$ZIPFILE" | grep -q "postgresql/version.tsv"; then
                      echo "ERROR: Missing PostgreSQL data"
                      exit 1
                  fi
                  echo "✓ PostgreSQL data found"

                  echo "=== Checking for pg_statviz data ==="
                  if ! unzip -l "$ZIPFILE" | grep -q "pg_statviz/testdb/snapshots.tsv"; then
                      echo "ERROR: Missing pg_statviz data"
                      unzip -l "$ZIPFILE" | grep pg_statviz || true
                      exit 1
                  fi
                  echo "✓ pg_statviz data found"

                  echo "=== Integration test PASSED ==="

                  # Shutdown PostgreSQL
                  sudo -u postgres /usr/lib/postgresql/18/bin/pg_ctl -D /var/lib/postgresql/18/main stop
                  EOF
                  chmod +x test-integration.sh

            - name: Build Docker image
              run: docker build -f Dockerfile.test -t radar-integration-test .

            - name: Run integration test in container
              env:
                  ROOT: ${{ matrix.root }}
                  PG_SUPERUSER: ${{ matrix.pg_superuser }}
              run: docker run --rm -e ROOT -e PG_SUPERUSER radar-integration-test

            - name: Clean up Docker images
              if: always()
              run: docker rmi radar-integration-test || true

    macos-test:
        name: macOS Build and Test
        runs-on: macos-latest
        needs: lint-and-test
        steps:
            - name: Check out code
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: '1.23'

            - name: Install PostgreSQL
              run: |
                  brew install postgresql@18
                  echo "/opt/homebrew/opt/postgresql@18/bin" >> $GITHUB_PATH
                  brew services start postgresql@18

            - name: Install pg_statviz extension
              run: |
                  git clone https://github.com/vyruss/pg_statviz.git /tmp/pg_statviz
                  cd /tmp/pg_statviz
                  make install PG_CONFIG=/opt/homebrew/opt/postgresql@18/bin/pg_config

            - name: Wait for PostgreSQL to be ready
              run: |
                  for i in {1..30}; do
                      if /opt/homebrew/opt/postgresql@18/bin/pg_isready -h localhost; then
                          echo "PostgreSQL is ready"
                          break
                      fi
                      echo "Waiting for PostgreSQL... ($i/30)"
                      sleep 1
                  done

            - name: Build radar for macOS
              run: CGO_ENABLED=0 go build -ldflags="-s -w" -o radar .

            - name: Create test database
              run: |
                  /opt/homebrew/opt/postgresql@18/bin/createdb testdb
                  /opt/homebrew/opt/postgresql@18/bin/psql -d testdb -c "CREATE EXTENSION IF NOT EXISTS pg_statviz;"
                  /opt/homebrew/opt/postgresql@18/bin/psql -d testdb -c "SELECT pgstatviz.snapshot();"

            - name: Run radar collection
              run: ./radar -d testdb -v

            - name: Verify output
              run: |
                  ZIPFILE=$(ls radar-*.zip 2>/dev/null | head -1)
                  if [ -z "$ZIPFILE" ]; then
                      echo "ERROR: No radar output file found"
                      ls -la
                      exit 1
                  fi
                  echo "Found output file: $ZIPFILE"
                  unzip -l "$ZIPFILE" | head -50

                  # Verify PostgreSQL data collected
                  if ! unzip -l "$ZIPFILE" | grep -q "postgresql/version.tsv"; then
                      echo "ERROR: Missing PostgreSQL data"
                      exit 1
                  fi
                  echo "✓ PostgreSQL data found"

                  # Verify system data collected
                  if ! unzip -l "$ZIPFILE" | grep -q "system/"; then
                      echo "ERROR: Missing system data"
                      exit 1
                  fi
                  echo "✓ System data found"
                  echo "=== macOS test PASSED ==="
